name: Application Deployment

on:
  push:
    branches:
    - main
    paths:
    - 'frontend/**'
    - 'auth-api/**'
    - 'todos-api/**'
    - 'users-api/**'
    - 'log-processor/**'
    - 'docker-compose.yml'
    - '.env.example'
  workflow_dispatch:


env:
  AWS_REGION: us-east-1

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      auth_changed: ${{ steps.changes.outputs.auth }}
      todos_changed: ${{ steps.changes.outputs.todos }}
      users_changed: ${{ steps.changes.outputs.users }}
      logs_changed: ${{ steps.changes.outputs.logs }}
      compose_changed: ${{ steps.changes.outputs.compose }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: Check Changed Files
      id: changes
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "frontend=true" >> $GITHUB_OUTPUT
          echo "auth=true" >> $GITHUB_OUTPUT
          echo "todos=true" >> $GITHUB_OUTPUT
          echo "users=true" >> $GITHUB_OUTPUT
          echo "logs=true" >> $GITHUB_OUTPUT
          echo "compose=true" >> $GITHUB_OUTPUT
        else
          git diff --name-only HEAD^ HEAD > changed_files.txt
          
          if grep -q "frontend/" changed_files.txt; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "âœ… Frontend changed"
          else
            echo "frontend=false" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "auth-api/" changed_files.txt; then
            echo "auth=true" >> $GITHUB_OUTPUT
            echo "âœ… Auth API changed"
          else
            echo "auth=false" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "todos-api/" changed_files.txt; then
            echo "todos=true" >> $GITHUB_OUTPUT
            echo "âœ… Todos API changed"
          else
            echo "todos=false" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "users-api/" changed_files.txt; then
            echo "users=true" >> $GITHUB_OUTPUT
            echo "âœ… Users API changed"
          else
            echo "users=false" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "log-processor/" changed_files.txt; then
            echo "logs=true" >> $GITHUB_OUTPUT
            echo "âœ… Log processor changed"
          else
            echo "logs=false" >> $GITHUB_OUTPUT
          fi
          
          if grep -q "docker-compose.yml" changed_files.txt; then
            echo "compose=true" >> $GITHUB_OUTPUT
            echo "âœ… Docker Compose changed"
          else
            echo "compose=false" >> $GITHUB_OUTPUT
          fi
        fi

  deploy-application:
    name: Deploy Application
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.frontend_changed == 'true' ||
      needs.detect-changes.outputs.auth_changed == 'true' ||
      needs.detect-changes.outputs.todos_changed == 'true' ||
      needs.detect-changes.outputs.users_changed == 'true' ||
      needs.detect-changes.outputs.logs_changed == 'true' ||
      needs.detect-changes.outputs.compose_changed == 'true'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0
        terraform_wrapper: false

    - name: Get Server IP from Terraform
      id: get_ip
      working-directory: ./infra/terraform
      run: |
        terraform init
        SERVER_IP=$(terraform output -raw server_public_ip)
        echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
        echo "ğŸ“ Deploying to: $SERVER_IP"

    - name: Setup SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ steps.get_ip.outputs.server_ip }} >> ~/.ssh/known_hosts

    - name: Deploy to Server
      env:
        SERVER_IP: ${{ steps.get_ip.outputs.server_ip }}
      run: |
        echo "ğŸš€ Deploying application to server..."

        ssh -i ~/.ssh/id_rsa ubuntu@$SERVER_IP << 'ENDSSH'
          set -e
          
          echo "ğŸ“‚ Navigating to application directory..."
          cd /opt/todo-app
          
          echo "ğŸ§¹ Discarding local changes..."
          git reset --hard HEAD
          git clean -fd
          
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main
          
          echo "ğŸ”„ Pulling latest images..."
          docker compose pull || true
          
          echo "ğŸ—ï¸  Building updated services..."
          docker compose build --no-cache
          
          echo "ğŸ›‘ Stopping old containers..."
          docker compose down
          
          echo "ğŸš€ Starting updated containers..."
          docker compose up -d
          
          echo "â³ Waiting for services to be ready..."
          sleep 10
          
          echo "ğŸ“Š Checking container status..."
          docker compose ps
          
          echo "âœ… Deployment complete!"
        ENDSSH

    - name: Verify Deployment
      env:
        SERVER_IP: ${{ steps.get_ip.outputs.server_ip }}
      run: |
        echo "ğŸ” Verifying deployment..."

        # Wait a bit for services to fully start
        sleep 15

        # Check if services are responding
        for i in {1..5}; do
          if curl -f -s https://kolawole.chickenkiller.com > /dev/null; then
            echo "âœ… Frontend is responding"
            break
          else
            echo "â³ Waiting for frontend... (attempt $i/5)"
            sleep 10
          fi
        done

        # Final check
        if curl -f -s https://kolawole.chickenkiller.com > /dev/null; then
          echo "âœ… Deployment verified successfully"
        else
          echo "âŒ Deployment verification failed"
          exit 1
        fi

    - name: Get Deployment Logs
      if: always()
      env:
        SERVER_IP: ${{ steps.get_ip.outputs.server_ip }}
      run: |
        echo "ğŸ“‹ Fetching recent logs..."
        ssh -i ~/.ssh/id_rsa ubuntu@$SERVER_IP << 'ENDSSH'
          cd /opt/todo-app
          echo "=== Container Status ==="
          docker compose ps
          echo ""
          echo "=== Recent Logs ==="
          docker compose logs --tail=30
        ENDSSH

    - name: Send Success Email
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âœ… Application Deployed Successfully - kolawole.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âœ… APPLICATION DEPLOYMENT SUCCESSFUL

          Your TODO application has been successfully deployed.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Deployed by: ${{ github.actor }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ğŸ“¦ Changed Services:
          - Frontend: ${{ needs.detect-changes.outputs.frontend_changed }}
          - Auth API: ${{ needs.detect-changes.outputs.auth_changed }}
          - Todos API: ${{ needs.detect-changes.outputs.todos_changed }}
          - Users API: ${{ needs.detect-changes.outputs.users_changed }}
          - Log Processor: ${{ needs.detect-changes.outputs.logs_changed }}
          - Docker Compose: ${{ needs.detect-changes.outputs.compose_changed }}

          ğŸŒ Application URL: https://kolawole.chickenkiller.com

          âœ¨ All services are now running the latest version.

    - name: Send Failure Email
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'âŒ Application Deployment Failed - kolawole.chickenkiller.com'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'DevOps CI/CD <${{ secrets.EMAIL_USERNAME }}>'
        body: |
          âŒ APPLICATION DEPLOYMENT FAILED

          The application deployment encountered an error.

          ğŸ“‹ Details:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          âš ï¸ ACTION REQUIRED:
          Please check the workflow logs for error details.

          ğŸ” Debug steps:
          1. SSH into server: ssh ubuntu@${{ steps.get_ip.outputs.server_ip }}
          2. Check logs: cd /opt/todo-app && docker compose logs
          3. Check status: docker compose ps

  no-changes-detected:
    name: No Application Changes
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.frontend_changed == 'false' &&
      needs.detect-changes.outputs.auth_changed == 'false' &&
      needs.detect-changes.outputs.todos_changed == 'false' &&
      needs.detect-changes.outputs.users_changed == 'false' &&
      needs.detect-changes.outputs.logs_changed == 'false' &&
      needs.detect-changes.outputs.compose_changed == 'false'
    runs-on: ubuntu-latest

    steps:
    - name: Log No Changes
      run: |
        echo "âœ… No application changes detected"
        echo "Skipping deployment"
