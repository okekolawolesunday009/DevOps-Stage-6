name: Deploy to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  prepare-deployment:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        # Create deployment directory with all source code
        mkdir -p deploy
        cp -r frontend deploy/
        cp -r auth-api deploy/
        cp -r todos-api deploy/
        cp -r users-api deploy/
        cp -r log-message-processor deploy/
        cp -r traefik deploy/
        cp docker-compose.yml deploy/
        cp .env deploy/
        
        # Create archive
        tar -czf deployment.tar.gz deploy/

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment.tar.gz
        retention-days: 1

  deploy:
    needs: prepare-deployment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download deployment package
      uses: actions/download-artifact@v4
      with:
        name: deployment-package
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add server to known hosts.
      run: |
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts

    - name: Copy files via rsync
      run: |
        rsync -avz --delete deployment.tar.gz ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/tmp/

    - name: Deploy via SSH
      run: |
        ssh ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
        set -e
        
        # Install Docker if not present
        if ! command -v docker &> /dev/null; then
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo usermod -aG docker $USER
          sudo systemctl enable docker
          sudo systemctl start docker
        fi
        
        # Install Docker Compose if not present
        if ! command -v docker-compose &> /dev/null; then
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
        fi
        
        # Extract deployment files
        cd /tmp && tar -xzf deployment.tar.gz
        
        # Backup current deployment
        sudo mkdir -p /opt/backups
        if [ -d "/opt/devops-app" ]; then
          sudo cp -r /opt/devops-app /opt/backups/devops-app-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
        fi
        
        # Update application
        sudo mkdir -p /opt/devops-app
        sudo cp -r deploy/* /opt/devops-app/
        cd /opt/devops-app
        
        # Set proper permissions
        sudo chown -R ubuntu:ubuntu /opt/devops-app
        
        # Stop existing containers
        sudo docker-compose down || true
        
        # Build and deploy
        sudo docker-compose up -d --build --remove-orphans
        
        # Clean up old images
        sudo docker image prune -f
        
        # Health check
        sleep 30
        curl -f https://www.prod.chickenkiller.com || curl -f http://localhost:8080 || echo "Health check failed but continuing..."
        
        echo "Deployment completed successfully!"
        sudo docker ps
        EOF