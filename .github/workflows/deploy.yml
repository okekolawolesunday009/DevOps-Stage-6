name: Application Deployment

on:
  push:
    branches: [ dev ]
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
      - '.env'
      - 'traefik/**'
  pull_request:
    branches: [ dev ]
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
      - '.env'
      - 'traefik/**'
  workflow_dispatch:

jobs:
  check-infrastructure:
    name: Check Infrastructure Status
    runs-on: ubuntu-latest
    outputs:
      server_exists: ${{ steps.check.outputs.server_exists }}
      server_ip: ${{ steps.check.outputs.server_ip }}
    
    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Check if server exists
      id: check
      run: |
        # Check if EC2 instance exists with our tag
        instance_info=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=devops-stage-6-server" "Name=instance-state-name,Values=running" \
          --query 'Reservations[*].Instances[*].[PublicIpAddress,InstanceId]' \
          --output text)
        
        if [ -n "$instance_info" ] && [ "$instance_info" != "None" ]; then
          server_ip=$(echo $instance_info | awk '{print $1}')
          instance_id=$(echo $instance_info | awk '{print $2}')
          echo "server_exists=true" >> $GITHUB_OUTPUT
          echo "server_ip=$server_ip" >> $GITHUB_OUTPUT
          echo "Server found: $instance_id with IP $server_ip"
        else
          echo "server_exists=false" >> $GITHUB_OUTPUT
          echo "No running server found with tag devops-stage-6-server"
        fi

  prepare-deployment:
    needs: check-infrastructure
    if: needs.check-infrastructure.outputs.server_exists == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        # Create deployment directory with all source code
        mkdir -p deploy
        cp -r frontend deploy/
        cp -r auth-api deploy/
        cp -r todos-api deploy/
        cp -r users-api deploy/
        cp -r log-message-processor deploy/
        cp -r traefik deploy/
        cp -r nginx deploy/
        cp docker-compose.yml deploy/
        cp .env deploy/
        
        # Create archive
        tar -czf deployment.tar.gz deploy/

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment.tar.gz
        retention-days: 1

  deploy:
    needs: [check-infrastructure, prepare-deployment]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.check-infrastructure.outputs.server_exists == 'true'
    
    steps:
    - name: Download deployment package
      uses: actions/download-artifact@v4
      with:
        name: deployment-package

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "deployment.tar.gz"
        target: "/tmp/"
        timeout: 300s

    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 300s
        script: |
          # Install Docker if not present
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            sudo systemctl enable docker
            sudo systemctl start docker
          fi
          
          # Remove old docker-compose and install latest version
          sudo rm -f /usr/local/bin/docker-compose
          sudo rm -f /usr/bin/docker-compose
          
          # Install latest Docker Compose v2 (compatible with newer Docker)
          DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
          sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          
          # Create symlink for backward compatibility
          sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          
          # Verify installation
          docker --version
          docker-compose --version
          
          # Extract deployment files
          cd /tmp && tar -xzf deployment.tar.gz
          
          # Backup current deployment
          sudo mkdir -p /opt/backups
          if [ -d "/opt/devops-app" ]; then
            sudo cp -r /opt/devops-app /opt/backups/devops-app-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
          fi
          
          # Update application
          sudo mkdir -p /opt/devops-app
          sudo cp -r deploy/* /opt/devops-app/
          cd /opt/devops-app
          
          # Set proper permissions
          sudo chown -R ubuntu:ubuntu /opt/devops-app
          
          # Stop existing containers (try both docker-compose and docker compose)
          sudo docker-compose down || sudo docker compose down || true

           
          # Clean up old images
          sudo docker image prune -f
          
          # Build and deploy (try docker-compose first, fallback to docker compose)
          sudo docker-compose up -d --build --remove-orphans || sudo docker compose up -d --build --remove-orphans
         
          # Health check - test both nginx and traefik
          sleep 30
          
          echo "=== Health Check Results ==="
          echo "Docker containers:"
          sudo docker ps -a
          
          echo "Nginx proxy test (port 80):"
          curl -f http://localhost/ || echo "Nginx proxy health check failed"
          
          echo "Nginx proxy test (port 8080):"
          curl -f http://localhost:8080/ || echo "Nginx alternative port check failed"
          
          echo "Frontend direct test:"
          curl -f http://localhost:8080/ || echo "Frontend direct check failed"
          
          echo "API endpoints via nginx:"
          curl -f http://localhost/api/auth/ || echo "Auth API via nginx failed"
          curl -f http://localhost/api/todos/ || echo "Todos API via nginx failed"  
          curl -f http://localhost/api/users/ || echo "Users API via nginx failed"
          
          echo "Traefik dashboard:"
          curl -f http://localhost:9080/ || echo "Traefik dashboard check failed"
          
          echo "External HTTPS check:"
          curl -f https://www.prod.chickenkiller.com || echo "External HTTPS check failed"
          
          echo "Deployment completed successfully!"