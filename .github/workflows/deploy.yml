name: Application Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  prepare-deployment:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        # Create deployment directory with all source code.
        mkdir -p deploy
        cp -r frontend deploy/
        cp -r auth-api deploy/
        cp -r todos-api deploy/
        cp -r users-api deploy/
        cp -r log-message-processor deploy/
        # Copy traefik config only if the directory exists (some setups don't include traefik files)
        if [ -d traefik ]; then
          cp -r traefik deploy/
        else
          echo "Warning: traefik directory not found, skipping"
        fi

        # Copy nginx config only if the directory exists
        if [ -d nginx ]; then
          cp -r nginx deploy/
        else
          echo "Warning: nginx directory not found, skipping"
        fi
        # Copy docker-compose file (support both .yml and .yaml)
        if [ -f docker-compose.yml ]; then
          cp docker-compose.yml deploy/
        elif [ -f docker-compose.yaml ]; then
          cp docker-compose.yaml deploy/
        else
          echo "Warning: docker-compose file not found (tried docker-compose.yml and docker-compose.yaml), skipping"
        fi

        # Copy .env only if present
        if [ -f .env ]; then
          cp .env deploy/
        else
          echo "Warning: .env not found, skipping"
        fi
        
        # Create archive
        tar -czf deployment.tar.gz deploy/

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment.tar.gz
        retention-days: 1

  deploy:
    needs: [prepare-deployment]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    
    steps:
    - name: Download deployment package
      uses: actions/download-artifact@v4
      with:
        name: deployment-package

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "deployment.tar.gz"
        target: "/tmp/"
        timeout: 300s

    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 300s
        script: |
          # Install Docker if not present
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            sudo systemctl enable docker
            sudo systemctl start docker
          fi
          
          # Remove old docker-compose and install latest version
          sudo rm -f /usr/local/bin/docker-compose
          sudo rm -f /usr/bin/docker-compose
          
          # Install latest Docker Compose v2 (compatible with newer Docker)
          DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
          sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          
          # Create symlink for backward compatibility
          sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          
          # Verify installation
          docker --version
          docker-compose --version
          
          # Extract deployment files
          cd /tmp && tar -xzf deployment.tar.gz
          
          # Backup current deployment
          sudo mkdir -p /opt/backups
          if [ -d "/opt/devops-app" ]; then
            sudo cp -r /opt/devops-app /opt/backups/devops-app-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
          fi
          
          # Update application
          sudo mkdir -p /opt/devops-app
          sudo cp -r deploy/* /opt/devops-app/
          cd /opt/devops-app
          
          # Set proper permissions
          sudo chown -R ubuntu:ubuntu /opt/devops-app
          
          # Stop existing containers (try both docker-compose and docker compose)
          sudo docker-compose down || sudo docker compose down || true

           
          # Clean up old images
          sudo docker image prune -f
          
          # Build and deploy (try docker-compose first, fallback to docker compose)
          sudo docker-compose up -d --build --remove-orphans || sudo docker compose up -d --build --remove-orphans
         
          # Health check - test both nginx and traefik
          sleep 30
          
          echo "=== Health Check Results ==="
          echo "Docker containers:"
          sudo docker ps -a
          
          echo "Nginx proxy test (port 80):"
          curl -f http://localhost/ || echo "Nginx proxy health check failed"
          
          echo "Nginx proxy test (port 8080):"
          curl -f http://localhost:8080/ || echo "Nginx alternative port check failed"
          
          echo "Frontend direct test:"
          curl -f http://localhost:8080/ || echo "Frontend direct check failed"
          
          echo "API endpoints via nginx:"
          curl -f http://localhost/api/auth/ || echo "Auth API via nginx failed"
          curl -f http://localhost/api/todos/ || echo "Todos API via nginx failed"  
          curl -f http://localhost/api/users/ || echo "Users API via nginx failed"
          
          echo "Traefik dashboard:"
          curl -f http://localhost:9080/ || echo "Traefik dashboard check failed"
          
          echo "External HTTPS check:"
          curl -f https://www.prod.chickenkiller.com || echo "External HTTPS check failed"
          
          echo "Deployment completed successfully!"