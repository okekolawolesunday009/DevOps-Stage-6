name: Deploy to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  prepare-deployment:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Create deployment package
      run: |
        # Create deployment directory with all source code
        mkdir -p deploy
        cp -r frontend deploy/
        cp -r auth-api deploy/
        cp -r todos-api deploy/
        cp -r users-api deploy/
        cp -r log-message-processor deploy/
        cp -r traefik deploy/
        cp docker-compose.yml deploy/
        cp .env deploy/
        
        # Create archive
        tar -czf deployment.tar.gz deploy/

    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: deployment-package
        path: deployment.tar.gz
        retention-days: 1

  deploy:
    needs: prepare-deployment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Download deployment package
      uses: actions/download-artifact@v4
      with:
        name: deployment-package

    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "deployment.tar.gz"
        target: "/tmp/"
        timeout: 300s

    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.8
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 300s
        script: |
          # Install Docker if not present
          if ! command -v docker &> /dev/null; then
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            sudo systemctl enable docker
            sudo systemctl start docker
          fi
          
          # Remove old docker-compose and install latest version
          sudo rm -f /usr/local/bin/docker-compose
          sudo rm -f /usr/bin/docker-compose
          
          # Install latest Docker Compose v2 (compatible with newer Docker)
          DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
          sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          
          # Create symlink for backward compatibility
          sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          
          # Verify installation
          docker --version
          docker-compose --version
          
          # Extract deployment files
          cd /tmp && tar -xzf deployment.tar.gz
          
          # Backup current deployment
          sudo mkdir -p /opt/backups
          if [ -d "/opt/devops-app" ]; then
            sudo cp -r /opt/devops-app /opt/backups/devops-app-$(date +%Y%m%d-%H%M%S) 2>/dev/null || true
          fi
          
          # Update application
          sudo mkdir -p /opt/devops-app
          sudo cp -r deploy/* /opt/devops-app/
          cd /opt/devops-app
          
          # Set proper permissions
          sudo chown -R ubuntu:ubuntu /opt/devops-app
          
          # Stop existing containers (try both docker-compose and docker compose)
          sudo docker-compose down || sudo docker compose down || true

           
          # Clean up old images
          sudo docker image prune -f
          
          # Build and deploy (try docker-compose first, fallback to docker compose)
          sudo docker-compose up -d --build --remove-orphans || sudo docker compose up -d --build --remove-orphans
         
          # Health check
          sleep 30
          curl -f https://www.prod.chickenkiller.com || curl -f http://localhost:8080 || echo "Health check failed but continuing..."
          
          echo "Deployment completed successfully!"
          sudo docker ps -a