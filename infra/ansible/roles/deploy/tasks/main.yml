---
# --- NEW: Wait for SSH connection ---
- name: Wait for SSH connection to be established
  ansible.builtin.wait_for_connection:
    timeout: 120
    delay: 10

# --- Ensure app directory exists ---
- name: Ensure app directory exists
  ansible.builtin.file:
    path: /opt/devops-app
    state: directory
    owner: "{{ ansible_user | default('ubuntu') }}"
    group: "{{ ansible_user | default('ubuntu') }}"
    mode: '0755'
  become: yes

# --- Clone the repository (or pull latest) ---
- name: Clone repo (or pull latest)
  ansible.builtin.git:
    repo: 'https://github.com/okekolawolesunday009/DevOps-Stage-6.git'
    dest: /opt/devops-app
    version: main
    force: yes
    update: yes
  become: yes

# --- Ensure Traefik ACME directory and acme.json exist with correct permissions ---
- name: Ensure Traefik ACME directory exists on host
  ansible.builtin.file:
    path: /opt/devops-app/letsencrypt
    state: directory
    owner: "{{ ansible_user | default('ubuntu') }}"
    group: "{{ ansible_user | default('ubuntu') }}"
    mode: '0755'
  become: yes

- name: Ensure acme.json exists with 0600 permissions
  ansible.builtin.file:
    path: /opt/devops-app/letsencrypt/acme.json
    state: touch
    owner: "{{ ansible_user | default('ubuntu') }}"
    group: "{{ ansible_user | default('ubuntu') }}"
    mode: '0600'
  become: yes

- name: setup ssl cert
  become: true
  shell: |
    cd /opt/devops-app/ && touch acme.json && chmod 600 acme.json
  args:
    executable: /bin/bash

# --- Start / update containers idempotently ---
- name: Bring up services idempotently without hanging
  community.docker.docker_compose_v2:
    project_src: /opt/devops-app
    build: missing      # only build if no image exists
    pull: missing       # only pull if image not present
    state: present
    recreate: smart     # recreate only if compose or Dockerfiles changed
    # timeout: 120
  become: yes
  

- name: Start application with Docker Compose
  become: true
  shell: |
    cd /opt/devops-app/ && docker compose up -d
  args:
    executable: /bin/bash
  